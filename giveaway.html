<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WinterGaming Giveaway Tool</title>

	<!-- Latest compiled and minified CSS -->
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
	

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="jumbotron">
		<center><h1>WinterGaming Giveaway Tool</h1></center>
		<center><p>Created by Wyatt Calandro - <a href='https://twitter.com/Arm1stice'>Twitter</a></p></center>
		<div class="row">
			<div class="col-md-8">
				<center><h1 id='currentviewers'>Current Chatters: ...</h3></center>
				<center><button class='btn btn-lg btn-success' id='pick'>Pick a Winner!</button></center><br><br><br>
				<center><span style='font-size: 100px' id='winner'></span></center>
			</div>
			<div class="col-md-4">
				<iframe frameborder="0" scrolling="no" id="chat_embed" src="http://twitch.tv/chat/embed?channel=wintergaming&popout_chat=true" height="500" width="500"></iframe>
			</div>
		</div>
	</div>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	<script src='http://chancejs.com/chance.min.js'></script>
	<script>
	setInterval(setViewerCount, 30000);
	setViewerCount();
	$("#pick").click(function(){
		$("#pick").prop('disabled', true);
		genViewerList(function(list){
			var newlist = shuffle(list);
			var length = newlist.length;
			for(var i = 0; i < length; i++){
				if(i == (length - 2)){
					console.log("Winner: " + newlist[0]);
					$("#winner").animate({opacity:0}, function(){
						$("#winner").text("Congrats " + newlist[0] + "!").animate({opacity:1}); 
					});
					break;
				}
				var max = newlist.length - 1;
				var number = chance.integer({min: 0, max: max});
				newlist.splice(number, 1);
				newlist = shuffle(newlist);
			}
			$("#pick").prop('disabled', false);
		});
	});
	function shuffle(array) {
		var currentIndex = array.length, temporaryValue, randomIndex ;

		// While there remain elements to shuffle...
		while (0 !== currentIndex) {

			// Pick a remaining element...
			randomIndex = Math.floor(Math.random() * currentIndex);
			currentIndex -= 1;

			// And swap it with the current element.
			temporaryValue = array[currentIndex];
			array[currentIndex] = array[randomIndex];
			array[randomIndex] = temporaryValue;
		}

		return array;
	}
	function genViewerList(callback){
		$.get("http://utilista.com:14567/viewers", function(data){
			callback(data.list);
		});
	}
	
	function genViewerCount(callback){
		$.get("http://utilista.com:14567/viewercount", function(data){
			callback(data.count);
		});
	}
	function setViewerCount(){
		genViewerCount(function(value){
			$("#currentviewers").text("Curent Chatters: " + value);
		});
	}
	</script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
	
    <!-- Latest compiled and minified JavaScript -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
  </body>
</html>